local addon = Unboxer
local class = addon:Namespace("rules")
local knownIds
local debug = false

-- Excluded
-- Most of these will be PTS containers that can be absolutely identified without reference to other rules.
-- Some, however, are special classes of container, such as the Shadowy Supplier drop "Unmarked Sack", which
-- can cause infinite loops if a Monk's Disguise is already in your inventory.
class.Excluded = addon.classes.Rule:Subclass()
function class.Excluded:New()
    return addon.classes.Rule.New(
        self, 
        {
            name = "excluded",
            title = "Excluded",
            exampleItemId = 69414,
            hidden = true,
            knownIds = knownIds,
        })
end

function class.Excluded:Match(data)
    if knownIds[data.itemId] -- Match preloaded ids
       or GetItemLinkOnUseAbilityInfo(data.itemLink) -- only PTS boxes grant abilities
       or self:MatchItemSetsText(data.name)
       or addon:StringContainsStringIdOrDefault(data.flavorText, SI_UNBOXER_ALL_LOWER) -- Contains the word " all " surrounded by spaces (if supported by locale)
       or addon:StringContainsStringIdOrDefault(data.flavorText, SI_UNBOXER_FOUND_LOWER) -- Contains the phrase " found in " surrounded by spaces (if supported by locale)
       or addon:StringContainsStringIdOrDefault(data.flavorText, SI_UNBOXER_FOUND2_LOWER)
       or addon:StringContainsStringIdOrDefault(data.flavorText, SI_UNBOXER_FULL_SUITE_LOWER) -- Contains the phrase "full set" or "full suite"
       or addon:StringContainsStringIdOrDefault(data.flavorText, SI_UNBOXER_FULL_SUITE2_LOWER)
       or addon:StringContainsStringIdOrDefault(data.flavorText, SI_UNBOXER_FULL_SUITE3_LOWER)
       or string.find(data.flavorText, " pts ")
       or string.find(data.flavorText, "^pts ")
       or addon:StringContainsStringIdOrDefault(data.name, SI_UNBOXER_INFINITE_LOWER)
       or addon:StringContainsStringIdOrDefault(data.name, SI_UNBOXER_TESTER_LOWER)
    then
        return self:IsUnboxableMatch()
    end
end

function class.Excluded:MatchItemSetsText(text)
  
    -- Need to exclude matches for Summerset (which, translated, also matches translated 'sets')
    local summerset = LocaleAwareToLower(GetZoneNameById(1011))
    if string.find(text, summerset) then return end
    
    local startIndex, endIndex = addon:StringContainsStringIdOrDefault(text, SI_UNBOXER_ITEM_SETS_LOWER)
    if startIndex == 1 or endIndex == ZoUTF8StringLength(text) then
        return true
    end
end

knownIds = {
  [69414] = true, -- Medium Tel Var Sack
  [79670] = true, -- Novice Assassin's Kit
  [55833]=1,[55834]=1,[55835]=1,[55836]=1,[59918]=1,[59919]=1,[59920]=1,[71025]=1,[71026]=1,[71027]=1,[71028]=1,
  [71029]=1,[71030]=1,[71031]=1,[71032]=1,[71033]=1,[71034]=1,[71035]=1,[71036]=1,[71037]=1,[71038]=1,[71039]=1,
  [71040]=1,[71041]=1,[71042]=1,[71043]=1,[71044]=1,[71045]=1,[71046]=1,[71047]=1,[71048]=1,[71049]=1,[71050]=1,
  [71482]=1,[71483]=1,[71484]=1,[71485]=1,[71486]=1,[71487]=1,[71488]=1,[71489]=1,[71490]=1,[71491]=1,[71492]=1,
  [71493]=1,[71494]=1,[71495]=1,[71496]=1,[71497]=1,[71498]=1,[71499]=1,[71500]=1,[71501]=1,[71502]=1,[71503]=1,
  [71504]=1,[71505]=1,[71506]=1,[71507]=1,[74687]=1,[74688]=1,[74689]=1,[74690]=1,[74691]=1,[74692]=1,[74693]=1,
  [74694]=1,[74696]=1,[74697]=1,[74698]=1,[75225]=1,[81183]=1,[94236]=1,[94237]=1,[94238]=1,[94239]=1,[94240]=1,
  [114127]=1,[114128]=1,[114129]=1,[114130]=1,[114131]=1,[114132]=1,[114133]=1,[114134]=1,[114135]=1,[114136]=1,
  [114137]=1,[114138]=1,[114139]=1,[114140]=1,[114141]=1,[114142]=1,[114143]=1,[114144]=1,[114145]=1,[114147]=1,
  [114148]=1,[114149]=1,[114150]=1,[114151]=1,[114152]=1,[114153]=1,[114154]=1,[114155]=1,[114156]=1,[114157]=1,
  [114158]=1,[114159]=1,[114160]=1,[114161]=1,[114162]=1,[114163]=1,[114164]=1,[114165]=1,[114166]=1,[114167]=1,
  [114168]=1,[114169]=1,[114170]=1,[114171]=1,[114172]=1,[114173]=1,[114174]=1,[114175]=1,[114176]=1,[114177]=1,
  [114178]=1,[114179]=1,[114180]=1,[114181]=1,[114182]=1,[114183]=1,[114184]=1,[114185]=1,[114186]=1,[114187]=1,
  [114188]=1,[114189]=1,[114190]=1,[114191]=1,[114192]=1,[114193]=1,[114194]=1,[114195]=1,[114196]=1,[114197]=1,
  [114198]=1,[114199]=1,[114200]=1,[114201]=1,[114202]=1,[114203]=1,[114204]=1,[114208]=1,[114209]=1,[114210]=1,
  [114211]=1,[114212]=1,[114213]=1,[114214]=1,[114215]=1,[114216]=1,[114217]=1,[114218]=1,[114219]=1,[114220]=1,
  [114221]=1,[114222]=1,[114223]=1,[114224]=1,[114225]=1,[114226]=1,[114227]=1,[114228]=1,[114229]=1,[114230]=1,
  [114231]=1,[114232]=1,[114233]=1,[114234]=1,[114235]=1,[114236]=1,[114237]=1,[114238]=1,[114239]=1,[114240]=1,
  [114241]=1,[114242]=1,[114243]=1,[114244]=1,[114245]=1,[114246]=1,[114247]=1,[114248]=1,[114249]=1,[114250]=1,
  [114251]=1,[114252]=1,[114253]=1,[114254]=1,[114255]=1,[114256]=1,[114257]=1,[114258]=1,[114259]=1,[114260]=1,
  [114261]=1,[114262]=1,[114263]=1,[114264]=1,[114265]=1,[114266]=1,[114267]=1,[114268]=1,[114269]=1,[114270]=1,
  [114271]=1,[114272]=1,[114273]=1,[114274]=1,[114277]=1,[114278]=1,[114279]=1,[114280]=1,[119566]=1,[121257]=1,
  [127110]=1,[127111]=1,[127112]=1,[127113]=1,[127114]=1,[127115]=1,[127116]=1,[127117]=1,[127118]=1,[127119]=1,
  [127120]=1,[127121]=1,[127122]=1,[127123]=1,[127124]=1,[127125]=1,[127126]=1,[127127]=1,[127128]=1,[127129]=1,
  [127130]=1,[127131]=1,[127144]=1,[127145]=1,[127146]=1,[132331]=1,[132338]=1,[132340]=1,[132347]=1,[133578]=1,
  [133579]=1,[133580]=1,[133581]=1,[133582]=1,[133583]=1,[133584]=1,[133585]=1,[133586]=1,[133587]=1,[133588]=1,
  [133589]=1,[133590]=1,[133591]=1,[133931]=1,[133932]=1,[133933]=1,[133934]=1,[133935]=1,[133936]=1,[133937]=1,
  [133938]=1,[133939]=1,[133940]=1,[133941]=1,[133942]=1,[133943]=1,[133944]=1,[133945]=1,[133947]=1,[133948]=1,
  [133949]=1,[133950]=1,[133951]=1,[133952]=1,[133953]=1,[133954]=1,[133955]=1,[133956]=1,[133957]=1,[133958]=1,
  [133959]=1,[133960]=1,[133961]=1,[133962]=1,[133963]=1,[133964]=1,[133965]=1,[133966]=1,[133967]=1,[133968]=1,
  [133969]=1,[133970]=1,[133971]=1,[133972]=1,[133973]=1,[133974]=1,[133975]=1,[133976]=1,[133977]=1,[133978]=1,
  [133979]=1,[133980]=1,[133981]=1,[133982]=1,[133984]=1,[133985]=1,[133986]=1,[133987]=1,[133988]=1,[133989]=1,
  [133990]=1,[133991]=1,[133992]=1,[133993]=1,[133994]=1,[133995]=1,[133996]=1,[133997]=1,[133998]=1,[133999]=1,
  [134000]=1,[134001]=1,[134002]=1,[134003]=1,[134004]=1,[134005]=1,[134006]=1,[134007]=1,[134008]=1,[134009]=1,
  [134010]=1,[134011]=1,[134012]=1,[134013]=1,[134014]=1,[134015]=1,[134016]=1,[134017]=1,[134018]=1,[134019]=1,
  [134020]=1,[134021]=1,[134022]=1,[134023]=1,[134024]=1,[134025]=1,[134026]=1,[134027]=1,[134028]=1,[134029]=1,
  [134030]=1,[134031]=1,[134032]=1,[134033]=1,[134034]=1,[134035]=1,[134036]=1,[134037]=1,[134038]=1,[134039]=1,
  [134040]=1,[134041]=1,[134042]=1,[134043]=1,[134044]=1,[134045]=1,[134046]=1,[134047]=1,[134048]=1,[134049]=1,
  [134050]=1,[134051]=1,[134052]=1,[134053]=1,[134054]=1,[134055]=1,[134056]=1,[134057]=1,[134058]=1,[134059]=1,
  [134060]=1,[134061]=1,[134062]=1,[134063]=1,[134064]=1,[134065]=1,[134066]=1,[134067]=1,[134068]=1,[134069]=1,
  [134070]=1,[134072]=1,[134073]=1,[134074]=1,[134075]=1,[134076]=1,[134077]=1,[134078]=1,[134079]=1,[134080]=1,
  [134081]=1,[134082]=1,[134083]=1,[134084]=1,[134085]=1,[134086]=1,[134087]=1,[134088]=1,[134089]=1,[134090]=1,
  [134091]=1,[134092]=1,[134093]=1,[134094]=1,[134095]=1,[134096]=1,[134097]=1,[134098]=1,[134099]=1,[134100]=1,
  [134101]=1,[134102]=1,[134103]=1,[134104]=1,[134105]=1,[134106]=1,[134107]=1,[134108]=1,[134109]=1,[134110]=1,
  [134111]=1,[134112]=1,[134113]=1,[134114]=1,[134115]=1,[134116]=1,[134117]=1,[134118]=1,[134119]=1,[134120]=1,
  [134121]=1,[134122]=1,[134123]=1,[134124]=1,[134125]=1,[134126]=1,[134127]=1,[134128]=1,[134129]=1,[134130]=1,
  [134131]=1,[134132]=1,[134133]=1,[134134]=1,[134135]=1,[134136]=1,[134137]=1,[134138]=1,[134139]=1,[134140]=1,
  [134141]=1,[134142]=1,[134143]=1,[134144]=1,[134145]=1,[134146]=1,[134147]=1,[134148]=1,[134149]=1,[134150]=1,
  [134151]=1,[134152]=1,[134153]=1,[134154]=1,[134155]=1,[134156]=1,[134157]=1,[134158]=1,[134159]=1,[134160]=1,
  [134161]=1,[134162]=1,[134163]=1,[134164]=1,[134165]=1,[134166]=1,[134167]=1,[134168]=1,[134169]=1,[134170]=1,
  [134171]=1,[134172]=1,[134173]=1,[134174]=1,[134175]=1,[134176]=1,[134177]=1,[134178]=1,[134179]=1,[134180]=1,
  [134181]=1,[134182]=1,[134183]=1,[134184]=1,[134185]=1,[134186]=1,[134187]=1,[134188]=1,[134189]=1,[134190]=1,
  [134191]=1,[134192]=1,[134193]=1,[134194]=1,[134195]=1,[134196]=1,[134197]=1,[134198]=1,[134199]=1,[134200]=1,
  [134201]=1,[134202]=1,[134203]=1,[134204]=1,[134205]=1,[134206]=1,[134207]=1,[134208]=1,[134209]=1,[134210]=1,
  [134211]=1,[134212]=1,[134213]=1,[134214]=1,[134215]=1,[134216]=1,[134217]=1,[134218]=1,[134219]=1,[134220]=1,
  [134221]=1,[134222]=1,[134223]=1,[134224]=1,[134225]=1,[134226]=1,[134227]=1,[134228]=1,[134229]=1,[134230]=1,
  [134231]=1,[134232]=1,[134233]=1,[134234]=1,[134235]=1,[134236]=1,[134237]=1,[134238]=1,[134239]=1,[134240]=1,
  [134241]=1,[134242]=1,[134595]=1,[134596]=1,[134597]=1,[134598]=1,[134599]=1,[134600]=1,[134601]=1,[134602]=1,
  [134603]=1,[134604]=1,[134605]=1,[134606]=1,[134607]=1,[134608]=1,[134609]=1,[134610]=1,[134611]=1,[134612]=1,
  [134613]=1,[134614]=1,[134615]=1,[134616]=1,[134625]=1,[134626]=1,[134627]=1,[134629]=1,[134671]=1,[134802]=1,
  [134803]=1,[134804]=1,[134805]=1,[134806]=1,[134807]=1,[134808]=1,[134809]=1,[134810]=1,[134811]=1,[134812]=1,
  [134813]=1,[134814]=1,[134815]=1,[134816]=1,[134817]=1,[134818]=1,[134819]=1,[134820]=1,[134821]=1,[134822]=1,
  [134850]=1,[134851]=1,[134852]=1,[138749]=1,[138750]=1,[138751]=1,[138752]=1,[138753]=1,[138754]=1,[138755]=1,
  [138756]=1,[138757]=1,[138758]=1,[138759]=1,[138760]=1,[138761]=1,[138762]=1,[138763]=1,[138764]=1,[138765]=1,
  [138766]=1,[138767]=1,[138768]=1,[138769]=1,[138770]=1,[138771]=1,[138772]=1,[138773]=1,[138774]=1,[138775]=1,
  [138776]=1,[138777]=1,[138778]=1,[138779]=1,[139021]=1,[139022]=1,[139023]=1,[139024]=1,[139025]=1,[139026]=1,
  [139027]=1,[139028]=1,[139029]=1,[139030]=1,[139031]=1,[139032]=1,[139033]=1,[139034]=1,[139035]=1,[139037]=1,
  [139038]=1,[139039]=1,[139040]=1,[139041]=1,[139042]=1,[139043]=1,[139044]=1,[139045]=1,[139046]=1,[139047]=1,
  [139048]=1,[139049]=1,[139050]=1,[139051]=1,[139052]=1,[139053]=1,[139054]=1,[140314]=1,[140315]=1,[140316]=1,
  [140317]=1,[140318]=1,[140319]=1,[140320]=1,[140321]=1,[140322]=1,[140323]=1,[140324]=1,[140325]=1,[140326]=1,
  [140327]=1,[140328]=1,[140329]=1,[140330]=1,[140331]=1,[140332]=1,[140333]=1,[140334]=1,[140335]=1,[140336]=1,
  [140337]=1,[140338]=1,[140339]=1,[140340]=1,[140341]=1,[140342]=1,[140343]=1,[140344]=1,[140345]=1,[140346]=1,
  [140347]=1,[140348]=1,[140349]=1,[140350]=1,[140351]=1,[140352]=1,[140353]=1,[140354]=1,[140355]=1,[140356]=1,
  [140357]=1,[140358]=1,[140359]=1,[140360]=1,[140361]=1,[140362]=1,[140363]=1,[140364]=1,[140365]=1,[140366]=1,
  [140367]=1,[140368]=1,[140369]=1,[140370]=1,[140371]=1,[140372]=1,[140373]=1,[140374]=1,[140375]=1,[140376]=1,
  [140377]=1,[141876]=1,[141877]=1,[141878]=1,[141879]=1,[141880]=1,[141881]=1,[141882]=1,[141883]=1,[141884]=1,
  [141885]=1,[141886]=1,[141887]=1,[141888]=1,[141889]=1,[141890]=1,[141891]=1,[141892]=1,[141893]=1,[141894]=1,
  [141895]=1,[141956]=1,[141977]=1,[141978]=1,[141979]=1,[141980]=1,[141981]=1,[141982]=1,[141983]=1,[141984]=1,
  [141985]=1,[141986]=1,[141987]=1,[141988]=1,[141989]=1,[141990]=1,[141991]=1,[141992]=1,[141993]=1,[141994]=1,
  [141995]=1,[141996]=1,[141997]=1,[145596]=1,[145916]=1,[145918]=1,[145919]=1,[145920]=1,[145921]=1,[145922]=1,
  [145924]=1,[145929]=1,[145930]=1,[145931]=1,[145932]=1,[145933]=1,[145934]=1,[145935]=1,[145936]=1,[145937]=1,
  [145938]=1,[145939]=1,[145940]=1,[145941]=1,[145942]=1,[145943]=1,[146018]=1,[146019]=1,[146020]=1,[146021]=1,
  [146022]=1,[146023]=1,[146024]=1,[146025]=1,[146026]=1,[146027]=1,[146028]=1,[146029]=1,[146030]=1,[146031]=1,
  [146032]=1,[146033]=1,[146034]=1,[146035]=1,[146036]=1,[146066]=1,[147301]=1,[147302]=1,[147303]=1,[147304]=1,
  [147305]=1,[147306]=1,[147307]=1,[147309]=1,[147310]=1,[147311]=1,[147312]=1,[147313]=1,[147314]=1,[147315]=1,
  [147316]=1,[147317]=1,[147318]=1,[147319]=1,[147320]=1,[147321]=1,[147322]=1,[147323]=1,[147324]=1,[147326]=1,
  [147327]=1,[147328]=1,[147329]=1,[147330]=1,[147331]=1,[147332]=1,[147333]=1,[147334]=1,[147335]=1,[147336]=1,
  [147337]=1,[147338]=1,[147339]=1,[147341]=1,[147342]=1,[147343]=1,[147344]=1,[147345]=1,[147346]=1,[147347]=1,
  [147348]=1,[147349]=1,[147350]=1,[147351]=1,[147352]=1,[147353]=1,[147354]=1,[147355]=1,[147356]=1,[147358]=1,
  [147359]=1,[147360]=1,[147361]=1,[147362]=1,[147363]=1,[147364]=1,[147435]=1,[147436]=1,[147437]=1,[147438]=1,
  [147439]=1,[147440]=1,[147441]=1,[147442]=1,[147443]=1,[147444]=1,[147445]=1,[147446]=1,[147447]=1,[147448]=1,
  [147449]=1,[147450]=1,[147451]=1,[147452]=1,[147453]=1,[147454]=1,[147455]=1,[147456]=1,[147457]=1,[147458]=1,
  [147459]=1,[147460]=1,[147461]=1,[147462]=1,[147463]=1,[147464]=1,[147465]=1,[147466]=1,[147467]=1,[147468]=1,
  [147469]=1,[147470]=1,[147471]=1,[147472]=1,[147473]=1,[147474]=1,[147475]=1,[147476]=1,[147478]=1,[147479]=1,
  [147480]=1,[147481]=1,[147482]=1,[147483]=1,[147484]=1,[147485]=1,[147486]=1,[147487]=1,[147534]=1,[147535]=1,
  [147536]=1,[147537]=1,[147538]=1,[147539]=1,[147540]=1,[147541]=1,[147542]=1,[147543]=1,[147544]=1,[147545]=1,
  [147546]=1,[147547]=1,[147548]=1,[147549]=1,[147550]=1,[147551]=1,[147552]=1,[147553]=1,[147554]=1,[147555]=1,
  [147556]=1,[147557]=1,[147558]=1,[147559]=1,[147560]=1,[147561]=1,[147562]=1,[147563]=1,[147604]=1,[147605]=1,
  [147606]=1,[147617]=1,[147618]=1,[147619]=1,[147620]=1,[147621]=1,[147622]=1,[147623]=1,[147624]=1,[147625]=1,
  [147626]=1,[147627]=1,[147628]=1,[147629]=1,[147630]=1,[147632]=1,[147633]=1,[147634]=1,[147660]=1,[147661]=1,
  [150420]=1,[150421]=1,[150422]=1,[150423]=1,[150424]=1,[150425]=1,[150426]=1,[150427]=1,[150428]=1,[150429]=1,
  [150430]=1,[150431]=1,[150432]=1,[150433]=1,[150434]=1,[150435]=1,[150436]=1,[150437]=1,[150438]=1,[150439]=1,
  [150440]=1,[150618]=1,[150619]=1,[150620]=1,[150621]=1,[150622]=1,[150623]=1,[150624]=1,[150625]=1,[150626]=1,
  [150627]=1,[150628]=1,[150629]=1,[150630]=1,[150631]=1,[150632]=1,[150633]=1,[150634]=1,[150635]=1,[150636]=1,
  [150637]=1,[150638]=1,[150639]=1,[150640]=1,[150641]=1,[150642]=1,[150643]=1,[150644]=1,[150645]=1,[150646]=1,
  [150647]=1,[150648]=1,[150649]=1,[150650]=1,[150651]=1,[150652]=1,[150653]=1,[150654]=1,[150655]=1,[150656]=1,
  [150657]=1,[150658]=1,[150659]=1,[150660]=1,[150661]=1,[150662]=1,[150663]=1,[150664]=1,[150665]=1,[150666]=1,
  [150674]=1,[150675]=1,[150676]=1,[150677]=1,[150678]=1,[150679]=1,[150680]=1,[150681]=1,[150682]=1,[150683]=1,
  [150685]=1,[150686]=1,[150688]=1,[150689]=1,[150690]=1,[150691]=1,[150692]=1,[150693]=1,[150695]=1,[150696]=1,
  [150697]=1,[150698]=1,[150699]=1,[150701]=1,[150702]=1,[150703]=1,[150704]=1,[150705]=1,[150706]=1,[150707]=1,
  [150708]=1,[150709]=1,[150710]=1,[150711]=1,[150712]=1,[150713]=1,[150714]=1,[150715]=1,[150716]=1,[150717]=1,
  [150718]=1,[150719]=1,[150720]=1,[151561]=1,[151562]=1,[151563]=1,[151564]=1,[151565]=1,[151566]=1,[151567]=1,
  [151568]=1,[151569]=1,[151570]=1,[151571]=1,[151572]=1,[151573]=1,[151574]=1,[151575]=1,[151576]=1,[151577]=1,
  [151578]=1,[151579]=1,[151580]=1,[151581]=1,[151582]=1,[151583]=1,[151584]=1,[151585]=1,[151586]=1,[151587]=1,
  [151588]=1,[151916]=1,[151917]=1,[151918]=1,[151919]=1,[151920]=1,[151921]=1,[151922]=1,[151923]=1,[151924]=1,
  [151925]=1,[151926]=1,[151927]=1,[151928]=1,[151929]=1,[151956]=1,[151957]=1,[151958]=1,[151959]=1,[151960]=1,
  [151961]=1,[151962]=1,[151963]=1,[151964]=1,[151965]=1,[151966]=1,[151967]=1,[152121]=1,[152122]=1,[152123]=1,
  [152124]=1,[152125]=1,[152126]=1,[152127]=1,[152128]=1,[152129]=1,[152130]=1,[152131]=1,[152132]=1,[152133]=1,
  [152134]=1,[152135]=1,[152136]=1,[152137]=1,[152138]=1,[152139]=1,[152140]=1,[152152]=1,[152153]=1,[152154]=1
}